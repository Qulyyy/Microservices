# Исправление ошибки контейнера в Яндекс.Облаке

## Проблема

При вызове контейнера возникает ошибка:
```json
{
  "errorMessage": "exit status 1",
  "errorType": "UserCodeError"
}
```

## Причины

1. **Приложение не слушает правильный порт** - Serverless Containers используют динамический PORT
2. **Использование development сервера Flask** - нужен production-ready сервер (gunicorn)
3. **Неправильная конфигурация контейнера**

## Исправления

### 1. Добавлен gunicorn в requirements.txt
```txt
gunicorn==21.2.0
```

### 2. Изменён Dockerfile
- Используется gunicorn вместо встроенного Flask сервера
- PORT берётся из переменных окружения
- Настроены workers и threads для production

### 3. Изменён app.py
- PORT читается из переменных окружений
- Убран debug режим для production

### 4. Обновлён CI/CD workflow
- Добавлен параметр `--listen-address 0.0.0.0`

## Что нужно сделать

### 1. Пересобрать и развернуть

После изменений нужно:
1. Сделать commit и push изменений
2. Дождаться выполнения CI/CD конвейера
3. Новая ревизия контейнера будет создана автоматически

### 2. Проверка в Яндекс.Облаке

1. Откройте **Serverless Containers**
2. Найдите ваш контейнер
3. Проверьте, что последняя ревизия:
   - Использует новый образ
   - Статус: **Active**
   - Правильно настроен PORT

### 3. Проверка логов

Если ошибка сохраняется:
1. Откройте контейнер в Яндекс.Облаке
2. Перейдите на вкладку **Логи**
3. Проверьте ошибки запуска

## Альтернативное решение (если проблема сохраняется)

Если после исправлений проблема остаётся, можно вручную обновить конфигурацию контейнера:

```bash
yc serverless container revision deploy \
  --container-name ваш-контейнер \
  --image cr.yandex/ваш-реестр/user-service:latest \
  --service-account-id ваш-sa-id \
  --cores 1 \
  --memory 128MB \
  --execution-timeout 30s \
  --concurrency 10 \
  --environment AUTH_SERVICE_URL=http://auth-service:5001 \
  --folder-id ваш-folder-id \
  --listen-address 0.0.0.0
```

## Проверка работы

После развёртывания проверьте:

```bash
# Health endpoint
curl https://ваш-url-контейнера/health

# Ожидаемый ответ:
{
  "status": "ok",
  "service": "user_service"
}
```

## Проблема: вечная загрузка страницы

Если страница контейнера загружается вечно:

1. **Проверьте логи контейнера:**
   - Откройте контейнер в Яндекс.Облаке
   - Перейдите на вкладку **Логи**
   - Посмотрите ошибки запуска

2. **Возможные причины:**
   - Контейнер не может прочитать PORT из переменных окружения
   - Gunicorn не запускается правильно
   - Недостаточно памяти (увеличьте до 256MB)

3. **Решение:**
   - Убедитесь, что используется правильная команда запуска
   - Проверьте, что PORT устанавливается автоматически Яндекс.Облаком
   - Увеличьте memory до 256MB если нужно

## Дополнительные настройки

Если нужно изменить ресурсы контейнера:
- `--cores 2` - увеличить CPU
- `--memory 256MB` - увеличить память
- `--execution-timeout 60s` - увеличить таймаут

