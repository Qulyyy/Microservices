# Решение ошибки "Service account is not available"

## Проблема

При развёртывании в Яндекс.Облако возникает ошибка:
```
ERROR: rpc error: code = InvalidArgument desc = Service account *** is not available
```

## Причины

1. **Сервисный аккаунт не имеет прав на использование самого себя**
   - Сервисный аккаунт должен иметь роль `iam.serviceAccounts.user`

2. **Неправильный ID сервисного аккаунта**
   - ID может быть указан неверно в секрете `YC_SA_ID`

3. **Сервисный аккаунт не существует или был удалён**
   - Проверьте, что сервисный аккаунт существует в каталоге

## Важно!

**Параметр `--service-account-id` ОБЯЗАТЕЛЕН для Serverless Containers!**

Ошибка "Field service_account_id is required" означает, что нужно явно указать сервисный аккаунт. Но при этом сервисный аккаунт должен иметь право использовать самого себя.

## Решения

### Решение 1: Назначить роль сервисному аккаунту (ОБЯЗАТЕЛЬНО!)

**Это обязательный шаг!** Без этой роли сервисный аккаунт не сможет использовать самого себя.

1. Откройте Яндекс.Облако
2. Перейдите в **Identity and Access Management (IAM)**
3. Найдите ваш сервисный аккаунт (ID: `ajefmgilj70ag4ufjuka` или имя, например, `sa-cicd`)
4. Назначьте роль `iam.serviceAccounts.user` самому себе:
   - Нажмите на сервисный аккаунт
   - Перейдите на вкладку **Роли**
   - Нажмите **Назначить роли**
   - Выберите роль `iam.serviceAccounts.user`
   - В поле "Субъект" выберите **тот же сервисный аккаунт** (важно!)
   - Нажмите **Сохранить**

**Проверка:** После назначения роли сервисный аккаунт должен иметь:
- `iam.serviceAccounts.user` (для использования самого себя)
- `container-registry.images.pusher` (для отправки образов)
- `serverless.containers.deployer` (для развёртывания контейнеров)

### Решение 2: Использовать сервисный аккаунт из JSON ключей

Workflow автоматически извлекает ID сервисного аккаунта из JSON ключей:
```yaml
SA_ID=$(cat /tmp/yc-keys.json | jq -r '.service_account_id // .id // empty')
```

Убедитесь, что в JSON файле есть поле `service_account_id` или `id`.

### Решение 3: Убрать параметр --service-account-id

Если сервисный аккаунт настроен в YC CLI через `service-account-key`, можно не указывать `--service-account-id` явно. YC CLI автоматически использует сервисный аккаунт из конфигурации.

### Решение 4: Проверить правильность секрета YC_SA_ID

1. Откройте Яндекс.Облако
2. Перейдите в **Сервисные аккаунты**
3. Найдите ваш сервисный аккаунт
4. Скопируйте **ID** (формат: `ajeXXXXXXXXXXXXX`)
5. Убедитесь, что этот ID совпадает с секретом `YC_SA_ID` в GitHub

## Проверка конфигурации

Workflow теперь выводит отладочную информацию:
- Список конфигурации YC CLI
- ID сервисного аккаунта из JSON ключей
- Какой метод используется для развёртывания

## Рекомендации

1. **Используйте сервисный аккаунт с минимальными необходимыми правами:**
   - `container-registry.images.pusher` - для отправки образов
   - `serverless.containers.deployer` - для развёртывания контейнеров
   - `iam.serviceAccounts.user` - для использования самого себя

2. **Проверьте, что сервисный аккаунт существует в правильном каталоге**

3. **Убедитесь, что JSON ключи содержат правильный ID сервисного аккаунта**

## Структура JSON ключей

Правильный формат JSON ключей:
```json
{
  "id": "ajexxxxxxxxxxxxxx",
  "service_account_id": "ajexxxxxxxxxxxxxx",
  "created_at": "2024-01-01T00:00:00.000000Z",
  "key_algorithm": "RSA_2048",
  "public_key": "...",
  "private_key": "..."
}
```

## Альтернативный подход

Если проблема сохраняется, можно создать новый сервисный аккаунт:
1. Создайте новый сервисный аккаунт
2. Назначьте ему все необходимые роли
3. Создайте новый авторизованный ключ
4. Обновите секрет `YC_KEYS` в GitHub

