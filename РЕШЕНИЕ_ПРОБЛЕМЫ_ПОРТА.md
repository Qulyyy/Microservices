# Решение проблемы с портом в Serverless Containers

## Проблема

Логи показывают:
- Gunicorn запускается на порту **5002**: `Listening at: http://0.0.0.0:5002`
- Яндекс.Облако пытается подключиться к порту **8080**: `Address 127.0.0.1:8080 is not available`
- Запросы отменяются через 30 секунд (таймаут)

## Причина

Serverless Containers в Яндекс.Облаке **автоматически устанавливают переменную окружения PORT** (обычно это **8080**), и ожидают, что приложение будет слушать именно на этом порту.

Если приложение слушает на другом порту (например, 5002), Яндекс.Облако не может к нему подключиться.

## Решение

### 1. Явно установить PORT=8080 в переменных окружения

При развёртывании в Serverless Containers нужно явно установить `PORT=8080`:

```yaml
--environment PORT=8080,AUTH_SERVICE_URL=...
```

**Важно:** Яндекс.Облако не устанавливает PORT автоматически, нужно указать его явно!

### 2. Использовать PORT в Dockerfile

В Dockerfile нужно использовать переменную `PORT`:

```dockerfile
ENV PORT=5002  # Для локальной разработки
CMD sh -c 'gunicorn --bind 0.0.0.0:${PORT} --workers 1 --threads 2 --timeout 30 --access-logfile - --error-logfile - app:app'
```

**Важно:** 
- Для локальной разработки: `PORT=5002` (из docker-compose.yml)
- Для Serverless Containers: `PORT=8080` (из --environment в CI/CD)

### 3. Проверка

После развёртывания проверьте логи:
- Должно быть: `Listening at: http://0.0.0.0:8080` (или другой PORT из окружения)
- Не должно быть ошибок: `Address 127.0.0.1:8080 is not available`

## Альтернативное решение

Если нужно использовать порт 5002 для локальной разработки, можно создать два разных Dockerfile:

1. **Dockerfile** - для локальной разработки (порт 5002)
2. **Dockerfile.prod** - для production в Яндекс.Облаке (порт из PORT)

Но проще использовать один Dockerfile с правильным значением по умолчанию.

## Проверка работы

После исправления:

1. Сделайте commit и push
2. Дождитесь выполнения CI/CD
3. Проверьте логи контейнера:
   - Должно быть: `Listening at: http://0.0.0.0:8080`
   - Не должно быть ошибок подключения
4. Проверьте работу:
   ```bash
   curl https://ваш-url-контейнера/health
   ```

## Итог

**Главное правило:** В Serverless Containers всегда используйте переменную окружения `PORT` и слушайте на том порту, который устанавливает Яндекс.Облако (обычно 8080).

