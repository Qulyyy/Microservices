# Решение проблемы с портом в Serverless Containers

## Проблема

Логи показывают:
- Gunicorn запускается на порту **5002**: `Listening at: http://0.0.0.0:5002`
- Яндекс.Облако пытается подключиться к порту **8080**: `Address 127.0.0.1:8080 is not available`
- Запросы отменяются через 30 секунд (таймаут)

## Причина

Serverless Containers в Яндекс.Облаке **автоматически устанавливают переменную окружения PORT** (обычно это **8080**), и ожидают, что приложение будет слушать именно на этом порту.

Если приложение слушает на другом порту (например, 5002), Яндекс.Облако не может к нему подключиться.

## Решение

### 1. Использовать PORT из переменных окружения

В Dockerfile нужно использовать переменную `PORT` без значения по умолчанию 5002:

```dockerfile
CMD sh -c 'gunicorn --bind 0.0.0.0:${PORT:-8080} --workers 1 --threads 2 --timeout 30 --access-logfile - --error-logfile - app:app'
```

**Важно:** Значение по умолчанию должно быть **8080**, а не 5002, так как Яндекс.Облако использует порт 8080.

### 2. Не устанавливать PORT в Dockerfile

Не нужно устанавливать `ENV PORT=5002` в Dockerfile, так как Яндекс.Облако установит свой PORT автоматически.

### 3. Проверка

После развёртывания проверьте логи:
- Должно быть: `Listening at: http://0.0.0.0:8080` (или другой PORT из окружения)
- Не должно быть ошибок: `Address 127.0.0.1:8080 is not available`

## Альтернативное решение

Если нужно использовать порт 5002 для локальной разработки, можно создать два разных Dockerfile:

1. **Dockerfile** - для локальной разработки (порт 5002)
2. **Dockerfile.prod** - для production в Яндекс.Облаке (порт из PORT)

Но проще использовать один Dockerfile с правильным значением по умолчанию.

## Проверка работы

После исправления:

1. Сделайте commit и push
2. Дождитесь выполнения CI/CD
3. Проверьте логи контейнера:
   - Должно быть: `Listening at: http://0.0.0.0:8080`
   - Не должно быть ошибок подключения
4. Проверьте работу:
   ```bash
   curl https://ваш-url-контейнера/health
   ```

## Итог

**Главное правило:** В Serverless Containers всегда используйте переменную окружения `PORT` и слушайте на том порту, который устанавливает Яндекс.Облако (обычно 8080).

