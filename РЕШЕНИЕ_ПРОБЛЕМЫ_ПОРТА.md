# Решение проблемы с портом в Serverless Containers

## Проблема

Логи показывают:
- Gunicorn запускается на порту **5002**: `Listening at: http://0.0.0.0:5002`
- Яндекс.Облако пытается подключиться к порту **8080**: `Address 127.0.0.1:8080 is not available`
- Запросы отменяются через 30 секунд (таймаут)

## Причина

Serverless Containers в Яндекс.Облаке **автоматически устанавливают переменную окружения PORT** (обычно это **8080**), и ожидают, что приложение будет слушать именно на этом порту.

Если приложение слушает на другом порту (например, 5002), Яндекс.Облако не может к нему подключиться.

## Решение

### ⚠️ ВАЖНО: PORT - зарезервированная переменная!

**Нельзя устанавливать PORT явно в переменных окружения!** Яндекс.Облако резервирует PORT для себя и устанавливает её автоматически (обычно 8080).

### 1. Установить PORT=8080 по умолчанию в Dockerfile

В Dockerfile нужно установить PORT=8080 по умолчанию:

```dockerfile
ENV PORT=8080  # По умолчанию для Serverless Containers
CMD sh -c 'gunicorn --bind 0.0.0.0:${PORT} --workers 1 --threads 2 --timeout 30 --access-logfile - --error-logfile - app:app'
```

### 2. Для локальной разработки установить PORT=5002 в docker-compose.yml

В docker-compose.yml нужно явно установить PORT=5002:

```yaml
environment:
  - PORT=5002  # Переопределяет значение из Dockerfile
  - AUTH_SERVICE_URL=http://auth_service:5001
```

**Важно:** 
- Для Serverless Containers: `PORT=8080` (по умолчанию из Dockerfile, Яндекс.Облако может переопределить)
- Для локальной разработки: `PORT=5002` (из docker-compose.yml переопределяет значение из Dockerfile)

### 3. Проверка

После развёртывания проверьте логи:
- Должно быть: `Listening at: http://0.0.0.0:8080` (или другой PORT из окружения)
- Не должно быть ошибок: `Address 127.0.0.1:8080 is not available`

## Альтернативное решение

Если нужно использовать порт 5002 для локальной разработки, можно создать два разных Dockerfile:

1. **Dockerfile** - для локальной разработки (порт 5002)
2. **Dockerfile.prod** - для production в Яндекс.Облаке (порт из PORT)

Но проще использовать один Dockerfile с правильным значением по умолчанию.

## Проверка работы

После исправления:

1. Сделайте commit и push
2. Дождитесь выполнения CI/CD
3. Проверьте логи контейнера:
   - Должно быть: `Listening at: http://0.0.0.0:8080`
   - Не должно быть ошибок подключения
4. Проверьте работу:
   ```bash
   curl https://ваш-url-контейнера/health
   ```

## Итог

**Главное правило:** В Serverless Containers всегда используйте переменную окружения `PORT` и слушайте на том порту, который устанавливает Яндекс.Облако (обычно 8080).

