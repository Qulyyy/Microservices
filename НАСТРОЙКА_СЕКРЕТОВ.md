# Настройка секретов для CI/CD

## Пошаговая инструкция

### Шаг 1: Переход к настройке секретов

1. Откройте ваш репозиторий на GitHub
2. Нажмите на вкладку **Settings** (в верхнем меню)
3. В левом меню выберите **Secrets and variables** → **Actions**
4. Нажмите кнопку **New repository secret**

### Шаг 2: Настройка DockerHub (Задание 1)

#### 2.1. Создание Personal Access Token

1. Зайдите на https://hub.docker.com
2. Войдите в свой аккаунт
3. Нажмите на ваш профиль (правый верхний угол) → **Account Settings**
4. Перейдите в **Security**
5. Нажмите **New Access Token**
6. Укажите описание: `GitHub Actions CI/CD`
7. Выберите права: **Read & Write**
8. Нажмите **Generate**
9. **ВАЖНО:** Скопируйте токен сразу (он больше не будет показан)

#### 2.2. Добавление секретов в GitHub

**DOCKERHUB_USERNAME:**
- Name: `DOCKERHUB_USERNAME`
- Secret: ваш логин на DockerHub (например, `myusername`)

**DOCKERHUB_TOKEN:**
- Name: `DOCKERHUB_TOKEN`
- Secret: токен, созданный на шаге 2.1

### Шаг 3: Настройка Яндекс.Облако (Задание 2)

#### 3.1. Создание Container Registry

1. Откройте https://console.cloud.yandex.ru
2. Выберите ваш каталог
3. Перейдите в **Container Registry**
4. Нажмите **Создать реестр**
5. Имя: `ikbo<номер_группы>` (например, `ikbo04`)
6. Нажмите **Создать**
7. Скопируйте **ID реестра** (формат: `crpXXXXXXXXXXXXX`)

#### 3.2. Создание сервисного аккаунта

1. Перейдите в **Сервисные аккаунты**
2. Если есть `sa-cicd`, используйте его, иначе создайте новый:
   - Нажмите **Создать сервисный аккаунт**
   - Имя: `sa-cicd` (или любое другое)
   - Нажмите **Создать**
3. Назначьте роли:
   - `container-registry.images.pusher` (для отправки образов)
   - `serverless.containers.deployer` (для развёртывания контейнеров)
4. Скопируйте **ID сервисного аккаунта** (формат: `ajeXXXXXXXXXXXXX`)

#### 3.3. Создание авторизованного ключа

1. Откройте созданный сервисный аккаунт
2. Перейдите на вкладку **Авторизованные ключи**
3. Нажмите **Создать авторизованный ключ**
4. Выберите **JSON**
5. В описании укажите: `GitHub Actions`
6. Нажмите **Создать**
7. **ВАЖНО:** Скачайте JSON файл
8. Откройте файл и скопируйте всё его содержимое

#### 3.4. Создание Serverless Container

1. Перейдите в **Serverless Containers**
2. Нажмите **Создать контейнер**
3. Имя: `<фамилия>-user-service` (например, `laptev-user-service`)
4. Описание: `User Service для микросервисной архитектуры`
5. Включите **Публичный доступ** (если нужен доступ извне)
6. Нажмите **Создать**
7. Скопируйте **имя контейнера**

#### 3.5. Получение ID каталога

1. Перейдите на главную страницу каталога
2. В адресной строке или на странице найдите **ID каталога**
3. Формат: `b1gXXXXXXXXXXXXX`

#### 3.6. Добавление секретов в GitHub

**YC_KEYS:**
- Name: `YC_KEYS`
- Secret: содержимое JSON файла с ключами (весь файл целиком)

**YC_REGISTRY_ID:**
- Name: `YC_REGISTRY_ID`
- Secret: ID реестра (например, `crpXXXXXXXXXXXXX`)

**YC_SA_ID:**
- Name: `YC_SA_ID`
- Secret: ID сервисного аккаунта (например, `ajeXXXXXXXXXXXXX`)

**YC_CONTAINER_NAME:**
- Name: `YC_CONTAINER_NAME`
- Secret: имя контейнера (например, `laptev-user-service`)

**YC_FOLDER_ID:**
- Name: `YC_FOLDER_ID`
- Secret: ID каталога (например, `b1gXXXXXXXXXXXXX`)

**AUTH_SERVICE_URL** (опционально):
- Name: `AUTH_SERVICE_URL`
- Secret: URL сервиса авторизации (по умолчанию: `http://auth-service:5001`)

## Проверка настройки

После добавления всех секретов:

1. Сделайте commit и push в ветку `main` или `master`
2. Перейдите в **Actions** на GitHub
3. Увидите запуск конвейера
4. Проверьте выполнение:
   - ✅ Тесты должны пройти
   - ✅ Образ должен быть отправлен в DockerHub
   - ✅ Образ должен быть отправлен в Yandex Container Registry
   - ✅ Контейнер должен быть развёрнут в Яндекс.Облаке

## Примеры значений секретов

```
DOCKERHUB_USERNAME = myusername
DOCKERHUB_TOKEN = dckr_pat_xxxxxxxxxxxxxxxxxxxx

YC_KEYS = {"id":"ajexxxxxx","service_account_id":"ajexxxxxx",...}
YC_REGISTRY_ID = crpxxxxxxxxxxxxxx
YC_SA_ID = ajexxxxxxxxxxxxxx
YC_CONTAINER_NAME = laptev-user-service
YC_FOLDER_ID = b1gxxxxxxxxxxxxxxxx
AUTH_SERVICE_URL = http://auth-service:5001
```

## Решение проблем

### Секреты не применяются

- Убедитесь, что секреты добавлены в правильный репозиторий
- Проверьте правильность написания имён секретов (чувствительны к регистру)
- После добавления секретов сделайте новый push

### Ошибка авторизации DockerHub

- Проверьте, что токен имеет права "Read & Write"
- Убедитесь, что логин правильный
- Попробуйте создать новый токен

### Ошибка авторизации Яндекс.Облако

- Проверьте, что JSON файл скопирован полностью
- Убедитесь, что сервисный аккаунт имеет нужные роли
- Проверьте, что ID реестра и каталога правильные

## Безопасность

⚠️ **ВАЖНО:**
- Никогда не коммитьте секреты в код
- Не делитесь секретами публично
- Регулярно обновляйте токены
- Используйте минимально необходимые права доступа

