name: CI/CD Pipeline

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        service:
          - auth_service
          - user_service
          - admin_service
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        working-directory: ./services/${{ matrix.service }}
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          # Установка зависимостей для тестирования
          pip install pytest pytest-cov requests || true
      
      - name: Check if unit tests exist
        id: check_unit_tests
        working-directory: ./services/${{ matrix.service }}
        run: |
          if [ -d "./tests/unit" ] && [ "$(ls -A ./tests/unit/*.py 2>/dev/null)" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Run unit tests
        if: steps.check_unit_tests.outputs.exists == 'true'
        working-directory: ./services/${{ matrix.service }}
        run: |
          python -m pytest ./tests/unit -v --cov=. --cov-report=term-missing
      
      - name: Skip unit tests (no tests found)
        if: steps.check_unit_tests.outputs.exists == 'false'
        run: |
          echo "No unit tests found for ${{ matrix.service }}, skipping..."
      
      - name: Set up Docker Compose
        if: matrix.service == 'auth_service' || matrix.service == 'user_service' || matrix.service == 'admin_service'
        run: |
          # Docker Compose V2 is included in newer Docker versions
          docker compose version || docker-compose version
      
      - name: Start services for e2e tests
        if: matrix.service == 'auth_service'
        run: |
          cd ${{ github.workspace }}
          docker compose up -d auth_service || docker-compose up -d auth_service
          sleep 10
      
      - name: Start services for e2e tests
        if: matrix.service == 'user_service'
        run: |
          cd ${{ github.workspace }}
          docker compose up -d auth_service user_service || docker-compose up -d auth_service user_service
          sleep 15
      
      - name: Start services for e2e tests
        if: matrix.service == 'admin_service'
        run: |
          cd ${{ github.workspace }}
          docker compose up -d auth_service admin_service || docker-compose up -d auth_service admin_service
          sleep 15
      
      - name: Check if e2e tests exist
        id: check_e2e_tests
        working-directory: ./services/${{ matrix.service }}
        run: |
          if [ -d "./tests/e2e" ] && [ "$(ls -A ./tests/e2e/*.py 2>/dev/null)" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Run e2e tests
        if: steps.check_e2e_tests.outputs.exists == 'true'
        working-directory: ./services/${{ matrix.service }}
        run: |
          python -m pytest ./tests/e2e -v
      
      - name: Skip e2e tests (no tests found)
        if: steps.check_e2e_tests.outputs.exists == 'false'
        run: |
          echo "No e2e tests found for ${{ matrix.service }}, skipping..."
      
      - name: Stop services
        if: always()
        run: |
          cd ${{ github.workspace }}
          docker compose down || docker-compose down || true

  # Задание 1: Непрерывная интеграция и доставка в DockerHub для auth_service
  build-and-push-dockerhub:
    name: Build and Push to DockerHub
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
      
      - name: Login to DockerHub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      
      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v4
        with:
          images: ${{ secrets.DOCKERHUB_USERNAME }}/auth-service
          tags: |
            type=ref,event=branch
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}
      
      - name: Build and push auth_service to DockerHub
        uses: docker/build-push-action@v4
        with:
          context: ./services/auth_service
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=registry,ref=${{ secrets.DOCKERHUB_USERNAME }}/auth-service:latest
          cache-to: type=inline,mode=max

  # Задание 2: Непрерывная интеграция и развёртывание в Яндекс.Облако для user_service
  build-and-deploy-yandex:
    name: Build and Deploy to Yandex Cloud
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
      
      - name: Install Yandex Cloud CLI
        run: |
          curl -sSL https://storage.yandexcloud.net/yandexcloud-yc/install.sh | bash
          echo "$HOME/yandex-cloud/bin" >> $GITHUB_PATH
          # Установка jq для работы с JSON
          sudo apt-get update && sudo apt-get install -y jq
      
      - name: Configure Yandex Cloud CLI
        run: |
          mkdir -p ~/.config/yandex-cloud
          # Сохраняем JSON ключи сервисного аккаунта
          echo '${{ secrets.YC_KEYS }}' > /tmp/yc-keys.json
          # Настраиваем YC CLI
          yc config profile create github-actions || true
          yc config set service-account-key /tmp/yc-keys.json
          yc config set folder-id ${{ secrets.YC_FOLDER_ID }}
          # Проверка конфигурации
          yc config list
      
      - name: Login to Yandex Container Registry
        run: |
          # Авторизация в Container Registry используя JSON ключи
          # Формат: весь JSON файл передается как пароль
          cat /tmp/yc-keys.json | docker login \
            --username json_key \
            --password-stdin \
            cr.yandex
      
      - name: Build Docker image
        run: |
          docker build -t cr.yandex/${{ secrets.YC_REGISTRY_ID }}/user-service:latest \
            ./services/user_service
      
      - name: Push to Yandex Container Registry
        run: |
          docker push cr.yandex/${{ secrets.YC_REGISTRY_ID }}/user-service:latest
      
      - name: Create/Update Serverless Container revision
        run: |
          # Проверяем, какой сервисный аккаунт используется
          echo "Checking YC CLI configuration..."
          yc config list
          
          # Извлекаем ID сервисного аккаунта из JSON ключей
          SA_ID=$(cat /tmp/yc-keys.json | jq -r '.service_account_id // empty' 2>/dev/null || echo "")
          
          if [ -z "$SA_ID" ]; then
            echo "ERROR: Could not extract service_account_id from JSON keys"
            echo "Please ensure YC_KEYS contains service_account_id field"
            exit 1
          fi
          
          echo "Using service account ID: $SA_ID"
          
          # Параметр --service-account-id обязателен для Serverless Containers
          # Используем сервисный аккаунт из JSON ключей
          # PORT устанавливается автоматически Яндекс.Облаком (обычно 8080)
          # Нельзя устанавливать PORT явно - это зарезервированная переменная
          yc serverless container revision deploy \
            --container-name ${{ secrets.YC_CONTAINER_NAME }} \
            --image cr.yandex/${{ secrets.YC_REGISTRY_ID }}/user-service:latest \
            --service-account-id "$SA_ID" \
            --cores 1 \
            --memory 128MB \
            --execution-timeout 30s \
            --concurrency 10 \
            --environment AUTH_SERVICE_URL=${{ secrets.AUTH_SERVICE_URL || 'http://auth-service:5001' }} \
            --folder-id ${{ secrets.YC_FOLDER_ID }}

  # Дополнительная работа: сборка остальных сервисов (без публикации)
  build-other-services:
    name: Build Other Services
    runs-on: ubuntu-latest
    needs: test
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
      
      - name: Build admin_service
        uses: docker/build-push-action@v4
        with:
          context: ./services/admin_service
          push: false
          tags: admin_service:latest
          cache-from: type=registry,ref=admin_service:latest
          cache-to: type=inline
