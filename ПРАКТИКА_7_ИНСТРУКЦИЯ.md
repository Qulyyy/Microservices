# Практическая работа №7. CI/CD

## Выполненные задания

✅ **Задание 1: Непрерывная интеграция и доставка в DockerHub**
- Настроен CI/CD конвейер для `auth_service`
- Автоматическая сборка Docker образа
- Отправка образа в DockerHub при push в main/master

✅ **Задание 2: Непрерывная интеграция и развёртывание в Яндекс.Облако**
- Настроен CI/CD конвейер для `user_service`
- Автоматическая сборка Docker образа
- Отправка образа в Yandex Container Registry
- Автоматическое развёртывание в Serverless Containers

## Структура CI/CD конвейера

Конвейер состоит из трёх основных jobs:

1. **test** - Запуск тестов для всех сервисов
2. **build-and-push-dockerhub** - Сборка и отправка auth_service в DockerHub
3. **build-and-deploy-yandex** - Сборка и развёртывание user_service в Яндекс.Облако

## Настройка секретов GitHub

### Для DockerHub (Задание 1)

Необходимо добавить следующие секреты в настройках репозитория GitHub:

1. Перейдите в Settings → Secrets and variables → Actions
2. Добавьте секреты:

**DOCKERHUB_USERNAME**
- Ваш логин на DockerHub
- Пример: `myusername`

**DOCKERHUB_TOKEN**
- Personal Access Token из DockerHub
- Создайте токен: https://hub.docker.com/settings/security
- Выберите "Read & Write" права

### Для Яндекс.Облако (Задание 2)

**YC_KEYS**
- JSON файл с ключами сервисного аккаунта
- Создайте сервисный аккаунт в Яндекс.Облаке
- Создайте авторизованный ключ
- Скачайте JSON файл и скопируйте его содержимое в секрет

**YC_REGISTRY_ID**
- ID реестра контейнеров
- Находится на странице Container Registry
- Формат: `crpXXXXXXXXXXXXX`

**YC_SA_ID**
- ID сервисного аккаунта
- Находится на странице сервисного аккаунта
- Формат: `ajeXXXXXXXXXXXXX`

**YC_CONTAINER_NAME**
- Имя бессерверного контейнера
- Формат: `<фамилия>-user-service`
- Пример: `laptev-user-service`

**YC_FOLDER_ID**
- ID каталога в Яндекс.Облаке
- Находится на странице каталога
- Формат: `b1gXXXXXXXXXXXXX`

**AUTH_SERVICE_URL** (опционально)
- URL сервиса авторизации
- Пример: `http://auth-service:5001`

## Как добавить секреты в GitHub

1. Откройте ваш репозиторий на GitHub
2. Перейдите в **Settings** → **Secrets and variables** → **Actions**
3. Нажмите **New repository secret**
4. Введите имя секрета (например, `DOCKERHUB_USERNAME`)
5. Введите значение секрета
6. Нажмите **Add secret**

Повторите для всех необходимых секретов.

## Создание DockerHub токена

1. Зайдите на https://hub.docker.com
2. Перейдите в **Account Settings** → **Security**
3. Нажмите **New Access Token**
4. Укажите описание (например, "GitHub Actions")
5. Выберите права: **Read & Write**
6. Скопируйте созданный токен
7. Добавьте его в секрет `DOCKERHUB_TOKEN`

## Настройка Яндекс.Облако

### Шаг 1: Создание Container Registry

1. Откройте Яндекс.Облако
2. Перейдите в **Container Registry**
3. Создайте реестр с именем `ikbo<номер_группы>`
4. Скопируйте ID реестра (для секрета `YC_REGISTRY_ID`)

### Шаг 2: Создание сервисного аккаунта

1. Перейдите в **Сервисные аккаунты**
2. Используйте существующий `sa-cicd` или создайте новый
3. Назначьте роли:
   - `container-registry.images.pusher`
   - `serverless.containers.deployer`
4. Создайте авторизованный ключ:
   - Нажмите "Создать авторизованный ключ"
   - Выберите "JSON"
   - Скачайте файл
   - Скопируйте содержимое в секрет `YC_KEYS`

### Шаг 3: Создание Serverless Container

1. Перейдите в **Serverless Containers**
2. Нажмите **Создать новый**
3. Название: `<фамилия>-user-service` (например, `laptev-user-service`)
4. Включите **Публичный доступ** (если нужен)
5. Скопируйте имя контейнера (для секрета `YC_CONTAINER_NAME`)

## Проверка работы конвейера

### Локальная проверка

1. Убедитесь, что тесты проходят:
   ```bash
   cd services/auth_service
   python -m pytest ./tests/unit -v
   ```

2. Проверьте сборку Docker образа:
   ```bash
   docker build -t auth-service:test ./services/auth_service
   ```

### Проверка в GitHub Actions

1. Сделайте commit и push в ветку `main` или `master`
2. Перейдите в **Actions** на GitHub
3. Увидите запуск конвейера
4. Проверьте выполнение всех jobs

### Проверка DockerHub

1. После успешного выполнения конвейера
2. Зайдите на https://hub.docker.com
3. Перейдите в ваш репозиторий
4. Увидите новый образ `auth-service`

### Проверка Яндекс.Облако

1. После успешного выполнения конвейера
2. Откройте **Container Registry**
3. Увидите образ `user-service` в реестре
4. Откройте **Serverless Containers**
5. Увидите новую ревизию контейнера

## Структура workflow

```yaml
jobs:
  test:                    # Запуск тестов
    - Unit тесты
    - E2E тесты
  
  build-and-push-dockerhub:  # Задание 1
    - Сборка auth_service
    - Отправка в DockerHub
  
  build-and-deploy-yandex:   # Задание 2
    - Сборка user_service
    - Отправка в Yandex Container Registry
    - Развёртывание в Serverless Containers
```

## Условия запуска

- **Тесты:** Запускаются при каждом push и pull request
- **DockerHub:** Запускается только при push в main/master
- **Яндекс.Облако:** Запускается только при push в main/master

## Примеры использования

### Локальная сборка для DockerHub

```bash
docker build -t myusername/auth-service:latest ./services/auth_service
docker login
docker push myusername/auth-service:latest
```

### Локальная сборка для Яндекс.Облако

```bash
# Авторизация
yc container registry configure-docker

# Сборка
docker build -t cr.yandex/<registry-id>/user-service:latest ./services/user_service

# Отправка
docker push cr.yandex/<registry-id>/user-service:latest
```

## Решение проблем

### Ошибка: "DockerHub authentication failed"

**Решение:** Проверьте секреты `DOCKERHUB_USERNAME` и `DOCKERHUB_TOKEN`

### Ошибка: "YC authentication failed"

**Решение:** 
1. Проверьте секрет `YC_KEYS` (должен быть валидный JSON)
2. Убедитесь, что сервисный аккаунт имеет нужные роли

### Ошибка: "Registry not found"

**Решение:** Проверьте секрет `YC_REGISTRY_ID` (должен быть правильный ID реестра)

### Ошибка: "Container not found"

**Решение:** 
1. Убедитесь, что контейнер создан в Яндекс.Облаке
2. Проверьте секрет `YC_CONTAINER_NAME` (должно совпадать с именем контейнера)

## Дополнительные настройки

### Переменные окружения для Serverless Container

В workflow уже настроены базовые переменные. Для добавления новых:

```yaml
--environment KEY1=value1,KEY2=value2
```

### Ресурсы для Serverless Container

По умолчанию:
- CPU: 1 vCPU
- Memory: 128MB
- Timeout: 30s
- Concurrency: 10

Для изменения измените параметры в workflow:
```yaml
--cores 2 \
--memory 256MB \
--execution-timeout 60s \
--concurrency 20
```

## Заключение

✅ Настроен CI/CD конвейер для двух сервисов
✅ Реализована доставка в DockerHub
✅ Реализовано развёртывание в Яндекс.Облако
✅ Все секреты документированы
✅ Конвейер готов к использованию

После настройки секретов конвейер будет автоматически:
1. Запускать тесты при каждом изменении
2. Собирать и отправлять образы в реестры
3. Развёртывать сервисы в production

